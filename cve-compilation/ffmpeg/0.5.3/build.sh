#!/bin/bash

if [ $ARCH == "riscv64" ]; then
  CC="riscv64-linux-gnu-gcc-11"
  #HOST="riscv64-linux-gnu"
  CC_DEB="gcc-11-riscv64-linux-gnu"
  ENABLE_CROSS="--enable-cross-compile --cross-prefix=riscv64-linux-gnu-"
  WITHARCH="--arch=$ARCH"
elif [ $ARCH == "arm" ]; then
  CC="arm-linux-gnueabihf-gcc-11"
  HOST="arm-linux-gnueabihf"
  ENABLE_CROSS="--enable-cross-compile --cross-prefix=arm-linux-gnueabihf- --disable-armv5te --disable-armv6 --disable-armv6t2"
  CC_DEB="gcc-11-arm-linux-gnueabihf"
  WITHARCH="--arch=armv7a"
elif [ $ARCH == "x86_64" ]; then
  CC="gcc"
  HOST=
  ENABLE_CROSS=
  CC_DEB=
  WITHARCH=
elif [ $ARCH == "i686" ]; then
  CC="gcc -m32"
  HOST=
  ENABLE_CROSS=
  CC_DEB="gcc-multilib"
  #CFLAGS="-m32"
  WITHARCH="--arch=x86_32"
elif [ $ARCH == "mips" ]; then
  CC="mips-linux-gnu-gcc"
  HOST="mips-linux-gnu"
  ENABLE_CROSS="--enable-cross-compile --cross-prefix=mips-linux-gnu-"
  CC_DEB="gcc-mips-linux-gnu"
  WITHARCH="--arch=$ARCH"
fi

mkdir -p output
for OPT in O0 O3; do
  if [ $OPT == "O0" ]; then
    DISOPT="--disable-optimizations"
  else
    DISOPT=
  fi
  echo Building for $ARCH-$OPT
  mkdir -p output
  make clean
  apt install $CC_DEB
  CFLAGS="-gdwarf-4 -${OPT}"
  ./configure $ENABLE_CROSS $WITHARCH --cc="$CC" $DISOPT --disable-stripping --enable-shared --enable-avfilter --prefix=$(pwd)/output/ && make -j16
  make install && cp output/bin/ffmpeg /root/cve-output/ffmpeg/$FF_VERSION/ffmpeg-$ARCH-gcc-$OPT \
  && cp output/bin/ffserver /root/cve-output/ffmpeg/$FF_VERSION/ffserver-$ARCH-gcc-$OPT && cp \
  output/lib/libavcodec.so /root/cve-output/ffmpeg/$FF_VERSION/libavcodec-$ARCH-gcc-$OPT \
  && cp output/lib/libavformat.so /root/cve-output/ffmpeg/$FF_VERSION/libavformat-$ARCH-gcc-$OPT \
  && cp output/lib/libavutil.so /root/cve-output/ffmpeg/$FF_VERSION/libavutil-$ARCH-gcc-$OPT \
  && cp output/lib/libavdevice.so /root/cve-output/ffmpeg/$FF_VERSION/libavdevice-$ARCH-gcc-$OPT \
  && cp output/lib/libavfilter.so /root/cve-output/ffmpeg/$FF_VERSION/libavfilter-$ARCH-gcc-$OPT
  make clean
done  



