#!/bin/bash

if [ $ARCH == "riscv64" ]; then
  CC="riscv64-linux-gnu-gcc-11"
  #HOST="riscv64-linux-gnu"
  CC_DEB="gcc-11-riscv64-linux-gnu"
  ENABLE_CROSS="--enable-cross-compile --cross-prefix=riscv64-linux-gnu- --target-os=linux"
  WITHARCH="--arch=$ARCH"
elif [ $ARCH == "arm" ]; then
  CC="arm-linux-gnueabihf-gcc-11"
  HOST="arm-linux-gnueabihf"
  ENABLE_CROSS="--enable-cross-compile --cross-prefix=arm-linux-gnueabihf- --target-os=linux --disable-inline-asm"
  CC_DEB="gcc-11-arm-linux-gnueabihf"
  WITHARCH="--arch=armv7-a --cpu=cortex-a7"
elif [ $ARCH == "x86_64" ]; then
  CC="gcc"
  HOST=
  ENABLE_CROSS=
  CC_DEB=
  WITHARCH=
elif [ $ARCH == "i686" ]; then
  CC="gcc -m32"
  HOST=
  ENABLE_CROSS=
  CC_DEB="gcc-multilib"
  #CFLAGS="-m32"
  WITHARCH="--arch=x86_32"
elif [ $ARCH == "mips" ]; then
  CC="mips-linux-gnu-gcc"
  HOST="mips-linux-gnu"
  ENABLE_CROSS="--enable-cross-compile --cross-prefix=mips-linux-gnu- --target-os=linux"
  CC_DEB="gcc-mips-linux-gnu"
  WITHARCH="--arch=$ARCH --cpu=24kc"
fi

mkdir -p output
for OPT in O0 O3; do
  echo Building for $ARCH-$OPT
  mkdir -p output
  make clean
  apt install $CC_DEB
  EXCFLAGS="-gdwarf-4 -${OPT}"
  CONFIG_OPT="--optflags=-${OPT} --enable-debug=dwarf-4 --disable-stripping --enable-shared --enable-avfilter"
  CFLAGS=$EXCFLAGS ./configure $ENABLE_CROSS $WITHARCH --cc="$CC" $CONFIG_OPT --prefix=$(pwd)/output/ && make -j16
  make install 
  ls output/bin/ | while read -r BIN_NAME;do
    file output/bin/$BIN_NAME | grep -q ELF && FLAG=1
    if [ ! -z $FLAG ];then
      cp output/bin/$BIN_NAME /root/cve-output/ffmpeg/$FF_VERSION/$BIN_NAME-$ARCH-gcc-$OPT
    fi
  done

  ls output/lib/ | grep .*.so$ | while read -r LIB_NAME; do
    cp output/lib/$LIB_NAME /root/cve-output/ffmpeg/$FF_VERSION/$LIB_NAME-$ARCH-gcc-$OPT
  done
  make clean
  rm -r output
done  



