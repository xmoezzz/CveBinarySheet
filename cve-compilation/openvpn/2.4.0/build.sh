#!/bin/bash

apt install libssl-dev libcap-ng-dev libpam0g-dev libnl-genl-3-dev net-tools 
mkdir -p output
for OPT in O0 O3; do
  echo Building for $ARCH-$OPT
  make clean
  CFLAGS="-g -${OPT}"
OPENSSL_CFLAGS="-I $(pwd)/deps/$ARCH-linux-gnu/include" OPENSSL_LIBS="-L$(pwd)/deps/$ARCH-linux-gnu/lib -lssl -lcrypto" CFLAGS=$CFLAGS CXXFLAGS=$CFLAGS ./configure --prefix=$(pwd)/output --disable-lzo --disable-lz4
  make -j16
  make install
  ls output/sbin/ | while read -r BIN_NAME;do
    file output/sbin/$BIN_NAME | grep -q ELF && FLAG=1
    if [ ! -z $FLAG ];then
      cp output/sbin/$BIN_NAME /home/root/share/openvpn/$OPENVPN_VERSION/$BIN_NAME-$ARCH-gcc-$OPT
    fi
  done

  find  output/lib/openvpn/plugins -type f -printf '%f\n' | grep '.*\.so' | while read -r BIN_NAME;do
    cp output/lib/openvpn/plugins/$BIN_NAME /home/root/share/openvpn/$OPENVPN_VERSION/$BIN_NAME-$ARCH-gcc-$OPT
  done

  make clean
  rm -rf output/*
done  



