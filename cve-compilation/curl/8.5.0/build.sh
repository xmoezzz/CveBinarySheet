#!/bin/bash

if [ $ARCH == "riscv64" ]; then
  CC="riscv64-linux-gnu-gcc-11 -g"
  HOST="riscv64-linux-gnu"
  WITH_HOST="--host=riscv64-linux-gnu"
  CC_DEB="gcc-11-riscv64-linux-gnu"
elif [ $ARCH == "arm" ]; then
  CC="arm-linux-gnueabihf-gcc-11 -g"
  HOST="arm-linux-gnueabihf"
  WITH_HOST="--host=arm-linux-gnueabihf"
  CC_DEB="gcc-11-arm-linux-gnueabihf"
elif [ $ARCH == "x86_64" ]; then
  CC="gcc -g"
  HOST=
  WITH_HOST=
  CC_DEB=
elif [ $ARCH == "i686" ]; then
  CC="gcc -g -m32"
  HOST=
  WITH_HOST=
  CC_DEB="gcc-multilib"
elif [ $ARCH == "mips" ]; then
  CC="mips-linux-gnu-gcc -g"
  HOST="mips-linux-gnu"
  WITH_HOST="--host=mips-linux-gnu"
  CC_DEB="gcc-mips-linux-gnu"
fi

mkdir -p output
for OPT in O0 O3; do
  echo Building for $ARCH-$OPT
  make clean
  apt install $CC_DEB
  export CC=$CC
  export CFLAGS="-g -${OPT}"
  CC=$CC CFLAGS=$CFLAGS ./configure --without-ssl --prefix=$(pwd)/output $WITH_HOST && make -j16
  make install && cp output/bin/curl /root/cve-output/curl/$CURL_VERSION/curl-$ARCH-gcc-$OPT \
    && cp output/lib/libcurl.so /root/cve-output/curl/$CURL_VERSION/libcurl-$ARCH-gcc-$OPT
  make clean
done  



