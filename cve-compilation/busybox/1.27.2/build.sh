#!/bin/bash

if [ $ARCH == "riscv64" ]; then
  CC="riscv64-linux-gnu-gcc-11"
  HOST="riscv64-linux-gnu"
  CC_DEB="gcc-11-riscv64-linux-gnu"
elif [ $ARCH == "arm" ]; then
  CC="arm-linux-gnueabihf-gcc-11"
  HOST="arm-linux-gnueabihf"
  WITH_HOST="--host=arm-linux-gnueabihf"
  CC_DEB="gcc-11-arm-linux-gnueabihf"
elif [ $ARCH == "x86_64" ]; then
  CC="gcc"
  HOST=""
  CC_DEB=
elif [ $ARCH == "i686" ]; then
  CC="gcc -m32"
  HOST=""
  CC_DEB="gcc-multilib"
#  MYCFLAGS="-m32"
elif [ $ARCH == "mips" ]; then
  CC="mips-linux-gnu-gcc"
  HOST="mips-linux-gnu"
  CC_DEB="gcc-mips-linux-gnu"
fi

if [ ! -f ".config" ]; then
  echo "Need copying config to project dir"
fi
apt install $CC_DEB
mkdir -p output
for OPT in O0 O1 O2 O3; do
  echo Building for $ARCH-$OPT
  make clean
  CFLAGS="-g -${OPT} $MYCFLAGS"
  if [ ! -z $HOST ]; then
    CROSS_COMPILE="$HOST-"
  fi
  make CROSS_COMPILE="$CROSS_COMPILE" CONFIG_PREFIX=."/output" CFLAGS="$CFLAGS" CC="$CC" -j16
  cp busybox_unstripped /root/cve-output/busybox/$BBOX_VERSION/busybox-$ARCH-gcc-$OPT
  make clean
done  



